script:
  - type: send
    at_ms: 100
    payload:
      type: event
      event: state_changed
      entity_id: binary_sensor.internet_connection
      new_state: {state: "off"}
  # Wait and see if it comes back
  - type: send
    at_ms: 5000
    payload:
      type: event
      event: state_changed
      entity_id: binary_sensor.internet_connection
      new_state: {state: "off"}
  # Still off, restart router
  - type: expect
    timeout_ms: 2000
    match:
      type: call_service
      domain: switch
      service: turn_off
      service_data: {entity_id: "switch.router_plug"}
  - type: expect
    timeout_ms: 2000
    match:
      type: call_service
      domain: switch
      service: turn_on
      service_data: {entity_id: "switch.router_plug"}
